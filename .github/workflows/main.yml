name: Run JMeter Tests

on:
  push:
    branches: 
      - main
  pull_request:
    branches: 
      - main
  workflow_dispatch:
    inputs:
      jmeter_script:
        description: 'JMeter test plan file to run (e.g., globalsqa-demo-site.jmx)'
        required: true
        default: 'globalsqa-demo-site.jmx'
      branch:
        description: 'Branch to checkout before running tests'
        required: true
        default: 'main'

jobs:
  jmeter-tests:
    runs-on: [self-hosted, windows, x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download JMeter
        run: |
          JMETER_VERSION=5.6.3
          wget https://downloads.apache.org//jmeter/binaries/apache-jmeter-$JMETER_VERSION.tgz
          tar -xzf apache-jmeter-$JMETER_VERSION.tgz
          echo "$GITHUB_WORKSPACE/apache-jmeter-$JMETER_VERSION/bin" >> $GITHUB_PATH

      - name: Run JMeter tests
        run: |
          JMETER_SCRIPT="${{ github.event.inputs.jmeter_script }}"
          # Fallback for non-manual triggers
          if [ -z "$JMETER_SCRIPT" ]; then
            JMETER_SCRIPT="globalsqa-demo-site.jmx"
          fi
          apache-jmeter-*/bin/jmeter -n -t "$JMETER_SCRIPT" -l results.jtl

      - name: Archive JMeter results
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: results.jtl
